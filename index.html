<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لعبة XO المطورة - بواسطة أحمد الغول</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #1a1a1a; 
            --panel-bg: #2c2c2c; 
            --primary: #00aaff; 
            --secondary: #ff4444; 
            --text-color: #f0f0f0; 
            --muted-color: #888; 
            --border-color: #444; 
            --cell-bg: #333; 
            --cell-hover: #444; 
            --success: #4caf50; 
            --warning: #ff9800;
            --info: #2196f3;
        }
        
        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            padding: 10px; 
            box-sizing: border-box; 
        }
        
        .app { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 20px; 
            width: 100%; 
            max-width: 1200px; 
        }
        
        .panel { 
            background-color: var(--panel-bg); 
            border-radius: 12px; 
            padding: 20px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
            transition: transform 0.3s ease; 
        }
        
        .panel:hover { 
            transform: translateY(-5px); 
        }
        
        .controls { 
            flex: 1; 
            min-width: 300px; 
        }
        
        .game-area { 
            flex: 2; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            min-width: 340px; 
        }
        
        h2, h3 { 
            color: var(--text-color); 
            border-bottom: 1px solid var(--border-color); 
            padding-bottom: 10px; 
            margin-top: 0; 
        }
        
        .section { 
            margin-bottom: 20px; 
        }
        
        .row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
            gap: 10px; 
        }
        
        label, .muted { 
            color: var(--muted-color); 
        }
        
        .tiny { 
            font-size: 0.8em; 
            color: var(--muted-color); 
        }
        
        select, input[type="text"], button { 
            width: 100%; 
            padding: 10px; 
            border-radius: 6px; 
            border: 1px solid var(--border-color); 
            background-color: var(--cell-bg); 
            color: var(--text-color); 
            font-family: 'Cairo', sans-serif; 
            box-sizing: border-box; 
        }
        
        button { 
            background-color: var(--primary); 
            border: none; 
            cursor: pointer; 
            font-weight: bold; 
            transition: all 0.3s; 
            position: relative; 
            overflow: hidden; 
        }
        
        button:hover:not(:disabled) { 
            background-color: #0088cc; 
            transform: translateY(-2px); 
        }
        
        button:active { 
            transform: translateY(1px); 
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        button.secondary { 
            background-color: var(--secondary); 
        }
        
        button.secondary:hover:not(:disabled) { 
            background-color: #cc3333; 
        }
        
        button.success { 
            background-color: var(--success); 
        }
        
        button.success:hover:not(:disabled) { 
            background-color: #3d8b40; 
        }
        
        button.warning { 
            background-color: var(--warning); 
        }
        
        button.warning:hover:not(:disabled) { 
            background-color: #e68900; 
        }
        
        #onlineSection, #chatSection { 
            display: none; 
            animation: fadeIn 0.5s ease; 
        }
        
        .status { 
            font-size: 0.9em; 
            padding: 8px; 
            border-radius: 4px; 
            background-color: rgba(0,0,0,0.2); 
            width: 100%; 
            text-align: center; 
            transition: all 0.3s;
            position: relative;
        }
        
        .status.connected { 
            color: var(--success); 
            background-color: rgba(76, 175, 80, 0.2); 
        }
        
        .status.connecting { 
            color: var(--warning); 
            background-color: rgba(255, 152, 0, 0.2); 
        }
        
        .status.error { 
            color: var(--secondary); 
            background-color: rgba(255, 68, 68, 0.2); 
        }
        
        .status.waiting { 
            color: var(--info); 
            background-color: rgba(33, 150, 243, 0.2); 
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }
        
        .status.connected .status-indicator {
            background-color: var(--success);
        }
        
        .status.connecting .status-indicator {
            background-color: var(--warning);
        }
        
        .status.error .status-indicator {
            background-color: var(--secondary);
        }
        
        .peer-id-display { 
            font-weight: bold; 
            user-select: all; 
            cursor: pointer; 
            color: var(--primary); 
            background: var(--bg-color); 
            padding: 8px; 
            border-radius: 4px; 
            text-align: center; 
            transition: all 0.3s; 
            position: relative; 
            width: 100%; 
        }
        
        #gameBoard { 
            display: grid; 
            grid-template-columns: repeat(3, minmax(80px, 100px)); 
            grid-template-rows: repeat(3, minmax(80px, 100px)); 
            gap: 10px; 
            margin-bottom: 20px; 
        }
        
        .cell { 
            width: 100%; 
            height: 100%; 
            background-color: var(--cell-bg); 
            border-radius: 8px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: 3em; 
            font-weight: bold; 
            cursor: pointer; 
            transition: all 0.3s; 
            position: relative;
        }
        
        .cell:hover:not(.x):not(.o) { 
            background-color: var(--cell-hover); 
            transform: scale(1.03); 
        }
        
        .cell.x { 
            color: var(--primary); 
            animation: appear 0.3s ease; 
        }
        
        .cell.o { 
            color: var(--secondary); 
            animation: appear 0.3s ease; 
        }
        
        .cell.win { 
            background-color: #ffd700 !important; 
            color: #1a1a1a; 
            animation: pulse 1s infinite; 
        }
        
        .cell.my-turn:not(.x):not(.o) {
            box-shadow: 0 0 10px var(--primary);
        }
        
        .cell.opponent-turn:not(.x):not(.o) {
            box-shadow: 0 0 10px var(--secondary);
        }
        
        #gameStatus { 
            font-size: 1.2em; 
            min-height: 40px; 
            color: var(--text-color); 
            text-align: center; 
            margin-bottom: 15px; 
            padding: 8px 15px; 
            border-radius: 20px; 
            background-color: rgba(0,0,0,0.2); 
            transition: all 0.3s; 
            position: relative;
        }
        
        .board-locked { 
            pointer-events: none; 
            opacity: 0.7; 
        }
        
        .score-board { 
            display: flex; 
            justify-content: space-around; 
            width: 100%; 
            margin-top: 20px; 
            background-color: rgba(0,0,0,0.2); 
            border-radius: 10px; 
            padding: 10px; 
        }
        
        .score-item { 
            text-align: center; 
        }
        
        .score-value { 
            font-size: 1.5em; 
            font-weight: bold; 
            color: var(--primary); 
        }
        
        .score-item:last-of-type .score-value { 
            color: var(--secondary); 
        }
        
        .connection-quality { 
            width: 100%; 
            height: 5px; 
            border-radius: 3px; 
            background-color: var(--muted-color); 
            margin-top: 5px; 
            position: relative; 
            overflow: hidden; 
        }
        
        .quality-indicator { 
            height: 100%; 
            width: 100%; 
            background-color: var(--success); 
            transition: width 0.5s, background-color 0.5s; 
        }
        
        .confetti-container { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            pointer-events: none; 
            z-index: 9999; 
        }
        
        .confetti { 
            position: absolute; 
            width: 10px; 
            height: 10px; 
            opacity: 0.7; 
            animation: fall 3s linear forwards; 
        }
        
        /* Chat & Voice Controls */
        #chatMessages { 
            height: 150px; 
            overflow-y: auto; 
            background-color: var(--bg-color); 
            border: 1px solid var(--border-color); 
            border-radius: 6px; 
            padding: 10px; 
            margin-bottom: 10px; 
            font-size: 0.9em; 
        }
        
        .chat-message { 
            margin-bottom: 8px; 
            padding: 5px 8px;
            border-radius: 8px;
            position: relative;
        }
        
        .chat-message.me { 
            text-align: left; 
            color: var(--primary); 
            background-color: rgba(0, 170, 255, 0.1);
            margin-right: 20px;
        }
        
        .chat-message.opponent { 
            text-align: right; 
            color: var(--secondary); 
            background-color: rgba(255, 68, 68, 0.1);
            margin-left: 20px;
        }
        
        .chat-message .sender { 
            font-weight: bold; 
            font-size: 0.8em;
            opacity: 0.8;
        }
        
        .chat-message .time {
            font-size: 0.7em;
            opacity: 0.6;
            margin-top: 2px;
        }
        
        /* Voice Chat Controls */
        .voice-controls {
            background-color: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
        }
        
        .voice-status {
            text-align: center;
            font-size: 0.9em;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
            background-color: rgba(0,0,0,0.3);
        }
        
        .voice-status.active {
            color: var(--success);
            background-color: rgba(76, 175, 80, 0.2);
        }
        
        .voice-status.muted {
            color: var(--warning);
            background-color: rgba(255, 152, 0, 0.2);
        }
        
        .voice-status.error {
            color: var(--secondary);
            background-color: rgba(255, 68, 68, 0.2);
        }
        
        .voice-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .voice-buttons button {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            font-size: 0.9em;
        }
        
        .mute-btn {
            position: relative;
        }
        
        .mute-btn.muted {
            background-color: var(--secondary) !important;
        }
        
        .mute-btn:not(.muted) {
            background-color: var(--success) !important;
        }
        
        .volume-indicator {
            height: 4px;
            background-color: var(--muted-color);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .volume-level {
            height: 100%;
            background-color: var(--success);
            transition: width 0.1s ease;
            border-radius: 2px;
        }
        
        .audio-visualizer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            margin-top: 10px;
            height: 30px;
        }
        
        .audio-bar {
            width: 3px;
            background-color: var(--primary);
            border-radius: 2px;
            transition: height 0.1s ease;
        }
        
        /* Modal Styles */
        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.7); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 10000; 
            animation: fadeIn 0.3s; 
        }
        
        .modal-content { 
            background: var(--panel-bg); 
            padding: 30px; 
            border-radius: 12px; 
            text-align: center; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.4); 
            max-width: 400px;
            width: 90%;
        }
        
        .modal-content p { 
            margin: 0 0 20px 0; 
            font-size: 1.2em; 
            line-height: 1.5;
        }
        
        .modal-buttons { 
            display: flex; 
            gap: 15px; 
            justify-content: center; 
            flex-wrap: wrap;
        }
        
        .modal-buttons button {
            min-width: 100px;
            flex: 1;
        }
        
        /* Loading animation */
        .loading {
            position: relative;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border: 2px solid var(--muted-color);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
        }
        
        @keyframes fall { 
            to { 
                transform: translateY(100vh) rotate(360deg); 
                opacity: 0; 
            } 
        }
        
        @keyframes fadeIn { 
            from { 
                opacity: 0; 
            } 
            to { 
                opacity: 1; 
            } 
        }
        
        @keyframes appear { 
            from { 
                transform: scale(0.8); 
                opacity: 0; 
            } 
            to { 
                transform: scale(1); 
                opacity: 1; 
            } 
        }
        
        @keyframes pulse { 
            0%, 100% { 
                opacity: 1; 
            } 
            50% { 
                opacity: 0.5; 
            } 
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            .app {
                flex-direction: column;
            }
            
            .controls {
                order: 2;
            }
            
            .game-area {
                order: 1;
            }
            
            #chatSection {
                order: 3;
            }
            
            #gameBoard {
                grid-template-columns: repeat(3, 90px);
                grid-template-rows: repeat(3, 90px);
            }
            
            .cell {
                font-size: 2.5em;
            }
            
            .voice-buttons {
                flex-direction: column;
            }
            
            .voice-buttons button {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
<div id="confetti-container"></div>
<div class="modal-overlay" id="modalOverlay">
    <div class="modal-content">
        <p id="modalText"></p>
        <div class="modal-buttons" id="modalButtons"></div>
    </div>
</div>

<div class="app">
    <div class="panel controls">
        <h2>إعدادات اللعبة</h2>
        <div class="section">
            <div class="row">
                <label class="muted">وضع اللعب</label>
                <select id="gameMode">
                    <option value="player">لاعب ضد لاعب (محلي)</option>
                    <option value="ai">ضد الكمبيوتر</option>
                    <option value="online">أونلاين (PeerJS)</option>
                </select>
            </div>
        </div>

        <div class="section" id="onlineSection">
            <h3 class="muted">اللعب أونلاين</h3>
            <div class="row">
                <div class="status" id="connectionStatus">
                    جارٍ التحضير...
                    <div class="status-indicator"></div>
                </div>
            </div>
            <div class="row">
                <button id="inviteBtn">
                    <i class="fas fa-share-alt"></i> إنشاء رابط دعوة
                </button>
            </div>
            <hr>
            <div class="row">
                <input type="text" id="remotePeerIdInput" placeholder="الصق معرّف أو رابط الدعوة هنا" />
            </div>
            <div class="row">
                <button id="connectBtn">اتصال بالخصم</button>
            </div>
            <div class="row">
                <button id="disconnectBtn" class="secondary" style="display: none;">
                    <i class="fas fa-disconnect"></i> قطع الاتصال
                </button>
            </div>
        </div>

        <div class="section">
            <h3 class="muted">أدوات التحكم</h3>
            <div class="row">
                <button id="restartBtn">
                    <i class="fas fa-redo"></i> إعادة اللعب
                </button>
            </div>
            <div class="row">
                <button id="newGameBtn" class="success">
                    <i class="fas fa-plus"></i> جولة جديدة
                </button>
            </div>
        </div>

        <div class="section">
            <h3 class="muted">النتائج</h3>
            <div class="score-board">
                <div class="score-item">
                    <div>X</div>
                    <div class="score-value" id="scoreX">0</div>
                </div>
                <div class="score-item">
                    <div>تعادل</div>
                    <div class="score-value" id="scoreDraw">0</div>
                </div>
                <div class="score-item">
                    <div>O</div>
                    <div class="score-value" id="scoreO">0</div>
                </div>
            </div>
        </div>
    </div>

    <div class="panel game-area">
        <div id="gameStatus">اختر وضع اللعب للبدء</div>
        <div id="gameBoard"></div>
        <div id="timer" style="font-size: 1.2em; color: var(--muted-color); margin-top: 15px;">00:00</div>
    </div>

    <div class="panel" id="chatSection" style="flex-basis: 100%;">
        <h3>التواصل</h3>
        
        <!-- Voice Chat Controls -->
        <div class="voice-controls" id="voiceControls">
            <div class="voice-status" id="voiceStatus">المكالمة الصوتية غير متاحة</div>
            
            <div class="voice-buttons">
                <button id="startVoiceBtn" class="success">
                    <i class="fas fa-microphone"></i> بدء المكالمة
                </button>
                <button id="muteBtn" class="mute-btn" style="display: none;">
                    <i class="fas fa-microphone"></i> كتم الصوت
                </button>
                <button id="endVoiceBtn" class="secondary" style="display: none;">
                    <i class="fas fa-phone-slash"></i> إنهاء المكالمة
                </button>
            </div>
            
            <div class="volume-indicator">
                <div class="volume-level" id="volumeLevel"></div>
            </div>
            
            <div class="audio-visualizer" id="audioVisualizer">
                <div class="audio-bar"></div>
                <div class="audio-bar"></div>
                <div class="audio-bar"></div>
                <div class="audio-bar"></div>
                <div class="audio-bar"></div>
            </div>
        </div>
        
        <!-- Text Chat -->
        <div>
            <h4 style="margin: 15px 0 10px 0; color: var(--muted-color);">الدردشة النصية</h4>
            <div id="chatMessages"></div>
            <form id="chatForm" class="row">
                <input type="text" id="chatInput" placeholder="اكتب رسالتك..." autocomplete="off" />
                <button type="submit" style="width: auto; padding: 10px 15px;">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>
</div>

<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Elements ---
    const gameModeSelect = document.getElementById('gameMode');
    const restartBtn = document.getElementById('restartBtn');
    const newGameBtn = document.getElementById('newGameBtn');
    const gameBoard = document.getElementById('gameBoard');
    const gameStatus = document.getElementById('gameStatus');
    const timerDisplay = document.getElementById('timer');
    const scoreX = document.getElementById('scoreX');
    const scoreDraw = document.getElementById('scoreDraw');
    const scoreO = document.getElementById('scoreO');
    const confettiContainer = document.getElementById('confetti-container');
    const onlineSection = document.getElementById('onlineSection');
    const connectionStatus = document.getElementById('connectionStatus');
    const inviteBtn = document.getElementById('inviteBtn');
    const remotePeerIdInput = document.getElementById('remotePeerIdInput');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const chatSection = document.getElementById('chatSection');
    const chatMessages = document.getElementById('chatMessages');
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const modalOverlay = document.getElementById('modalOverlay');
    const modalText = document.getElementById('modalText');
    const modalButtons = document.getElementById('modalButtons');
    
    // Voice chat elements
    const voiceControls = document.getElementById('voiceControls');
    const voiceStatus = document.getElementById('voiceStatus');
    const startVoiceBtn = document.getElementById('startVoiceBtn');
    const muteBtn = document.getElementById('muteBtn');
    const endVoiceBtn = document.getElementById('endVoiceBtn');
    const volumeLevel = document.getElementById('volumeLevel');
    const audioVisualizer = document.getElementById('audioVisualizer');

    // --- Game State ---
    let boardState = Array(9).fill(null);
    let currentPlayer = 'X';
    let gameActive = true;
    let gameMode = 'player';
    let scores = { X: 0, O: 0, draw: 0 };
    let gameTimer = null;
    let timeElapsed = 0;
    let gameCount = 0;

    // --- Network State ---
    let peer = null;
    let conn = null;
    let myRole = '';
    let isConnected = false;
    let connectionTimeout = null;

    // --- Voice Chat State ---
    let localStream = null;
    let remoteStream = null;
    let call = null;
    let isMuted = false;
    let isVoiceActive = false;
    let audioContext = null;
    let analyser = null;
    let microphone = null;
    let volumeCheckInterval = null;

    // --- Audio Elements ---
    const remoteAudio = new Audio();
    remoteAudio.autoplay = true;
    remoteAudio.volume = 1.0;

    // --- Sounds with fallback ---
    const sounds = {
        move: createBeep(800, 0.1),
        win: createBeep(523.25, 0.3),
        draw: createBeep(261.63, 0.5),
        click: createBeep(1000, 0.05),
        voiceStart: createBeep(440, 0.2),
        voiceEnd: createBeep(220, 0.3)
    };

    function createBeep(frequency, duration) {
        return {
            play: () => {
                try {
                    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioCtx.createOscillator();
                    const gainNode = audioCtx.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioCtx.destination);
                    
                    oscillator.frequency.value = frequency;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                    
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + duration);
                } catch (e) {
                    console.log('Audio not supported');
                }
            }
        };
    }

    function playSound(type) { 
        if (sounds[type]) { 
            sounds[type].play(); 
        } 
    }

    // --- Voice Chat Functions ---
    async function initializeVoiceChat() {
        try {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                throw new Error('Voice chat not supported');
            }

            voiceStatus.textContent = 'جاهز للمكالمة الصوتية';
            voiceStatus.className = 'voice-status';
            startVoiceBtn.style.display = 'block';
            
        } catch (error) {
            console.error('Voice chat initialization failed:', error);
            voiceStatus.textContent = 'المكالمة الصوتية غير متاحة';
            voiceStatus.className = 'voice-status error';
        }
    }

    async function startVoiceCall() {
        try {
            voiceStatus.textContent = 'جارٍ بدء المكالمة...';
            voiceStatus.className = 'voice-status connecting';
            
            localStream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    sampleRate: 44100
                } 
            });

            setupAudioAnalyzer();
            
            if (conn && conn.open) {
                // Send voice call request
                sendNetworkMessage({ 
                    type: 'voice_call_request',
                    timestamp: Date.now()
                });
                
                voiceStatus.textContent = 'في انتظار موافقة الخصم...';
                voiceStatus.className = 'voice-status connecting';
            } else {
                throw new Error('No connection available');
            }
            
        } catch (error) {
            console.error('Failed to start voice call:', error);
            voiceStatus.textContent = 'فشل في بدء المكالمة';
            voiceStatus.className = 'voice-status error';
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
        }
    }

    function setupAudioAnalyzer() {
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            microphone = audioContext.createMediaStreamSource(localStream);
            
            analyser.fftSize = 256;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            microphone.connect(analyser);
            
            // Start volume monitoring
            volumeCheckInterval = setInterval(() => {
                analyser.getByteFrequencyData(dataArray);
                const average = dataArray.reduce((a, b) => a + b) / bufferLength;
                const volume = (average / 255) * 100;
                
                volumeLevel.style.width = volume + '%';
                updateAudioVisualizer(dataArray);
            }, 100);
            
        } catch (error) {
            console.error('Audio analyzer setup failed:', error);
        }
    }

    function updateAudioVisualizer(dataArray) {
        const bars = audioVisualizer.querySelectorAll('.audio-bar');
        const step = Math.floor(dataArray.length / bars.length);
        
        bars.forEach((bar, index) => {
            const value = dataArray[index * step] || 0;
            const height = Math.max(2, (value / 255) * 30);
            bar.style.height = height + 'px';
        });
    }

    function acceptVoiceCall() {
        if (peer && localStream) {
            call = peer.call(conn.peer, localStream);
            setupCallHandlers();
            
            voiceStatus.textContent = 'المكالمة نشطة';
            voiceStatus.className = 'voice-status active';
            updateVoiceButtons(true);
            isVoiceActive = true;
            
            playSound('voiceStart');
        }
    }

    function setupCallHandlers() {
        if (!call) return;
        
        call.on('stream', (stream) => {
            remoteStream = stream;
            remoteAudio.srcObject = stream;
            
            voiceStatus.textContent = 'المكالمة نشطة';
            voiceStatus.className = 'voice-status active';
            updateVoiceButtons(true);
            isVoiceActive = true;
        });
        
        call.on('close', () => {
            endVoiceCall();
        });
        
        call.on('error', (error) => {
            console.error('Call error:', error);
            voiceStatus.textContent = 'خطأ في المكالمة';
            voiceStatus.className = 'voice-status error';
            endVoiceCall();
        });
    }

    function toggleMute() {
        if (!localStream) return;
        
        isMuted = !isMuted;
        localStream.getAudioTracks().forEach(track => {
            track.enabled = !isMuted;
        });
        
        muteBtn.classList.toggle('muted', isMuted);
        muteBtn.innerHTML = isMuted ? 
            '<i class="fas fa-microphone-slash"></i> إلغاء الكتم' : 
            '<i class="fas fa-microphone"></i> كتم الصوت';
        
        voiceStatus.textContent = isMuted ? 'المكالمة نشطة (مكتوم)' : 'المكالمة نشطة';
        voiceStatus.className = isMuted ? 'voice-status muted' : 'voice-status active';
        
        // Send mute status to peer
        sendNetworkMessage({
            type: 'voice_mute_status',
            isMuted: isMuted,
            timestamp: Date.now()
        });
    }

    function endVoiceCall() {
        isVoiceActive = false;
        isMuted = false;
        
        if (volumeCheckInterval) {
            clearInterval(volumeCheckInterval);
            volumeCheckInterval = null;
        }
        
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        
        if (remoteStream) {
            remoteStream.getTracks().forEach(track => track.stop());
            remoteStream = null;
        }
        
        if (call) {
            call.close();
            call = null;
        }
        
        if (audioContext) {
            audioContext.close();
            audioContext = null;
        }
        
        remoteAudio.srcObject = null;
        
        voiceStatus.textContent = 'تم إنهاء المكالمة';
        voiceStatus.className = 'voice-status';
        updateVoiceButtons(false);
        
        volumeLevel.style.width = '0%';
        const bars = audioVisualizer.querySelectorAll('.audio-bar');
        bars.forEach(bar => bar.style.height = '2px');
        
        playSound('voiceEnd');
        
        // Notify peer
        sendNetworkMessage({
            type: 'voice_call_ended',
            timestamp: Date.now()
        });
        
        setTimeout(() => {
            if (!isVoiceActive) {
                voiceStatus.textContent = 'جاهز للمكالمة الصوتية';
            }
        }, 2000);
    }

    function updateVoiceButtons(isActive) {
        if (isActive) {
            startVoiceBtn.style.display = 'none';
            muteBtn.style.display = 'block';
            endVoiceBtn.style.display = 'block';
        } else {
            startVoiceBtn.style.display = 'block';
            muteBtn.style.display = 'none';
            endVoiceBtn.style.display = 'none';
            muteBtn.classList.remove('muted');
            muteBtn.innerHTML = '<i class="fas fa-microphone"></i> كتم الصوت';
        }
    }

    // --- Enhanced UI & Modal Functions ---
    function showModal(text, buttons) {
        modalText.textContent = text;
        modalButtons.innerHTML = '';
        buttons.forEach(btnInfo => {
            const button = document.createElement('button');
            button.textContent = btnInfo.text;
            button.className = btnInfo.class || '';
            button.onclick = () => {
                playSound('click');
                btnInfo.action();
                modalOverlay.style.display = 'none';
            };
            modalButtons.appendChild(button);
        });
        modalOverlay.style.display = 'flex';
    }

    function showTemporaryStatus(message, duration = 2000, type = 'info') {
        const originalText = gameStatus.textContent;
        const originalBg = gameStatus.style.backgroundColor;
        
        gameStatus.textContent = message;
        
        switch(type) {
            case 'success':
                gameStatus.style.backgroundColor = 'rgba(76, 175, 80, 0.3)';
                break;
            case 'error':
                gameStatus.style.backgroundColor = 'rgba(255, 68, 68, 0.3)';
                break;
            case 'warning':
                gameStatus.style.backgroundColor = 'rgba(255, 152, 0, 0.3)';
                break;
            default:
                gameStatus.style.backgroundColor = 'rgba(33, 150, 243, 0.3)';
        }
        
        setTimeout(() => { 
            if (gameStatus.textContent === message) {
                gameStatus.textContent = originalText; 
                gameStatus.style.backgroundColor = originalBg;
            }
        }, duration);
    }

    function updateConnectionStatus(status, message) {
        connectionStatus.className = `status ${status}`;
        connectionStatus.innerHTML = `${message} <div class="status-indicator"></div>`;
        
        if (status === 'connected') {
            isConnected = true;
            connectBtn.style.display = 'none';
            disconnectBtn.style.display = 'block';
            remotePeerIdInput.disabled = true;
            initializeVoiceChat();
        } else {
            isConnected = false;
            connectBtn.style.display = 'block';
            disconnectBtn.style.display = 'none';
            remotePeerIdInput.disabled = false;
            
            if (isVoiceActive) {
                endVoiceCall();
            }
            
            voiceStatus.textContent = 'المكالمة الصوتية غير متاحة';
            voiceStatus.className = 'voice-status error';
            updateVoiceButtons(false);
        }
    }

    // --- Enhanced Game Logic ---
    function createBoard() {
        gameBoard.innerHTML = '';
        for (let i = 0; i < 9; i++) {
            const cell = document.createElement('div');
            cell.classList.add('cell');
            cell.dataset.index = i;
            cell.addEventListener('click', handleCellClick);
            gameBoard.appendChild(cell);
        }
        updateBoardVisuals();
    }

    function updateBoardVisuals() {
        const cells = document.querySelectorAll('.cell');
        cells.forEach(cell => {
            cell.classList.remove('my-turn', 'opponent-turn');
        });

        if (gameMode === 'online' && gameActive && isConnected) {
            if (currentPlayer === myRole) {
                cells.forEach(cell => {
                    if (!cell.textContent) {
                        cell.classList.add('my-turn');
                    }
                });
            } else {
                cells.forEach(cell => {
                    if (!cell.textContent) {
                        cell.classList.add('opponent-turn');
                    }
                });
            }
        }
    }

    function handleCellClick(event) {
        if (!gameActive) return;
        const index = parseInt(event.target.dataset.index, 10);
        if (boardState[index] !== null) return;

        if (gameMode === 'online') {
            if (!isConnected) {
                showTemporaryStatus("غير متصل بالخصم!", 1500, 'error');
                return;
            }
            
            if (currentPlayer !== myRole) {
                showTemporaryStatus("انتظر دورك!", 1500, 'warning');
                return;
            }
        }

        makeMove(index, currentPlayer);

        if (gameMode === 'online' && isConnected) {
            sendNetworkMessage({ 
                type: 'move', 
                index: index, 
                player: currentPlayer,
                gameCount: gameCount,
                timestamp: Date.now()
            });
            lockBoard();
        } else if (gameMode === 'ai' && gameActive) {
            togglePlayer();
            lockBoard();
            setTimeout(aiMove, 500);
        } else {
            if (gameActive) togglePlayer();
        }
    }

    function makeMove(index, player) {
        if (!gameActive || boardState[index] !== null) return;
        
        playSound('move');
        boardState[index] = player;
        const cell = document.querySelector(`.cell[data-index='${index}']`);
        cell.textContent = player;
        cell.classList.add(player.toLowerCase());

        if (checkWin(player)) {
            endGame(false, player);
        } else if (boardState.every(cell => cell !== null)) {
            endGame(true);
        }
    }

    function togglePlayer() {
        currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
        updateStatus();
        updateBoardVisuals();
    }

    function updateStatus() {
        if (!gameActive) return;
        
        let statusText = `الدور على اللاعب: ${currentPlayer}`;
        let bgColor = 'rgba(0,0,0,0.2)';
        
        if (gameMode === 'online' && isConnected) {
            if (currentPlayer === myRole) {
                statusText += " (أنت)";
                bgColor = 'rgba(0, 170, 255, 0.2)';
            } else {
                statusText += " (الخصم)";
                bgColor = 'rgba(255, 68, 68, 0.2)';
            }
        } else if (gameMode === 'ai') {
            statusText = (currentPlayer === 'X') ? "دورك للعب" : "الكمبيوتر يفكر...";
            bgColor = (currentPlayer === 'X') ? 'rgba(0, 170, 255, 0.2)' : 'rgba(255, 152, 0, 0.2)';
        }
        
        gameStatus.textContent = statusText;
        gameStatus.style.backgroundColor = bgColor;
    }

    function checkWin(player, board = boardState) {
        const winConditions = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8], // Rows
            [0, 3, 6], [1, 4, 7], [2, 5, 8], // Columns
            [0, 4, 8], [2, 4, 6]             // Diagonals
        ];
        
        const winningCombination = winConditions.find(combination => 
            combination.every(index => board[index] === player)
        );
        
        if (winningCombination && board === boardState) {
            winningCombination.forEach(index => 
                document.querySelector(`.cell[data-index='${index}']`).classList.add('win')
            );
        }
        
        return !!winningCombination;
    }

    function endGame(isDraw, winner = null) {
        gameActive = false;
        clearInterval(gameTimer);
        
        if (isDraw) {
            playSound('draw');
            gameStatus.textContent = 'انتهت اللعبة بالتعادل!';
            gameStatus.style.backgroundColor = 'rgba(255, 193, 7, 0.3)';
            scores.draw++;
        } else {
            playSound('win');
            let statusText = `اللاعب ${winner} فاز!`;
            let bgColor = winner === 'X' ? 'rgba(0, 170, 255, 0.3)' : 'rgba(255, 68, 68, 0.3)';
            
            if (gameMode === 'online') {
                if (winner === myRole) {
                    statusText = `فزت! (${winner})`;
                    createConfetti();
                } else {
                    statusText = `فاز الخصم (${winner})`;
                }
            } else if (gameMode === 'ai') {
                if (winner === 'X') {
                    statusText = 'فزت!';
                    createConfetti();
                } else {
                    statusText = 'فاز الكمبيوتر!';
                }
            } else {
                createConfetti();
            }
            
            gameStatus.textContent = statusText;
            gameStatus.style.backgroundColor = bgColor;
            scores[winner]++;
        }
        
        updateScores();
        unlockBoard();
    }

    function startGame() {
        boardState.fill(null);
        gameActive = true;
        currentPlayer = 'X';
        gameCount++;
        createBoard();
        updateStatus();
        clearInterval(gameTimer);
        timeElapsed = 0;
        updateTimer();
        gameTimer = setInterval(updateTimer, 1000);
        unlockBoard();

        if (gameMode === 'online' && isConnected) {
            chatSection.style.display = 'block';
            if (myRole === 'X') {
                gameStatus.textContent = "دورك للعب (X)";
                gameStatus.style.backgroundColor = 'rgba(0, 170, 255, 0.2)';
            } else {
                lockBoard();
                gameStatus.textContent = "في انتظار حركة الخصم (O)";
                gameStatus.style.backgroundColor = 'rgba(255, 68, 68, 0.2)';
            }
        } else {
            chatSection.style.display = 'none';
            gameStatus.style.backgroundColor = 'rgba(0,0,0,0.2)';
        }
        
        updateBoardVisuals();
    }

    function updateTimer() { 
        timeElapsed++; 
        const minutes = Math.floor(timeElapsed/60).toString().padStart(2,'0');
        const seconds = (timeElapsed%60).toString().padStart(2,'0');
        timerDisplay.textContent = `${minutes}:${seconds}`;
    }

    function updateScores() { 
        scoreX.textContent = scores.X; 
        scoreO.textContent = scores.O; 
        scoreDraw.textContent = scores.draw; 
        if (gameMode !== 'online') {
            localStorage.setItem('xoScores', JSON.stringify(scores));
        }
    }

    function resetScores() { 
        scores = { X: 0, O: 0, draw: 0 }; 
        updateScores(); 
    }

    function lockBoard() { 
        gameBoard.classList.add('board-locked'); 
    }

    function unlockBoard() { 
        gameBoard.classList.remove('board-locked'); 
    }

    function createConfetti() { 
        for (let i = 0; i < 50; i++) { 
            const confetti = document.createElement('div'); 
            confetti.className = 'confetti'; 
            confetti.style.left = Math.random()*100+'vw'; 
            confetti.style.animationDelay = Math.random()*-3+'s'; 
            confetti.style.backgroundColor = `hsl(${Math.random()*360},100%,50%)`; 
            confettiContainer.appendChild(confetti); 
            setTimeout(() => confetti.remove(), 3000); 
        } 
    }

    // --- AI Logic (Minimax) ---
    function aiMove() {
        const bestMove = findBestMove(boardState);
        if (bestMove !== -1) {
            makeMove(bestMove, 'O');
            if (gameActive) togglePlayer();
        }
        unlockBoard();
    }

    function findBestMove(board) {
        let bestVal = -1000;
        let bestMove = -1;
        
        for (let i = 0; i < 9; i++) {
            if (board[i] === null) {
                board[i] = 'O';
                let moveVal = minimax(board, 0, false);
                board[i] = null;
                
                if (moveVal > bestVal) {
                    bestMove = i;
                    bestVal = moveVal;
                }
            }
        }
        return bestMove;
    }

    function minimax(board, depth, isMax) {
        const score = evaluate(board);
        
        if (score === 10) return score - depth;
        if (score === -10) return score + depth;
        if (board.every(cell => cell !== null)) return 0;

        if (isMax) {
            let best = -1000;
            for (let i = 0; i < 9; i++) {
                if (board[i] === null) {
                    board[i] = 'O';
                    best = Math.max(best, minimax(board, depth + 1, !isMax));
                    board[i] = null;
                }
            }
            return best;
        } else {
            let best = 1000;
            for (let i = 0; i < 9; i++) {
                if (board[i] === null) {
                    board[i] = 'X';
                    best = Math.min(best, minimax(board, depth + 1, !isMax));
                    board[i] = null;
                }
            }
            return best;
        }
    }

    function evaluate(board) {
        if (checkWin('O', board)) return 10;
        if (checkWin('X', board)) return -10;
        return 0;
    }

    // --- Enhanced Network & Chat Logic ---
    function handleGameModeChange() {
        gameMode = gameModeSelect.value;
        onlineSection.style.display = (gameMode === 'online') ? 'block' : 'none';
        chatSection.style.display = 'none';
        resetScores();
        
        cleanupConnection();
        
        if (gameMode !== 'online') {
            const savedScores = localStorage.getItem('xoScores');
            if (savedScores) {
                scores = JSON.parse(savedScores);
            }
            updateScores();
        } else {
            initializePeer();
        }
        
        startGame();
    }

    function cleanupConnection() {
        if (connectionTimeout) {
            clearTimeout(connectionTimeout);
            connectionTimeout = null;
        }
        
        if (isVoiceActive) {
            endVoiceCall();
        }
        
        if (conn) {
            conn.close();
            conn = null;
        }
        
        if (peer && !peer.destroyed) {
            peer.destroy();
            peer = null;
        }
        
        isConnected = false;
        updateConnectionStatus('waiting', 'جارٍ التحضير...');
    }

    function initializePeer() {
        if (peer && !peer.destroyed) {
            peer.destroy();
        }
        
        updateConnectionStatus('connecting', 'جارٍ التحضير...');
        
        peer = new Peer({
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            }
        });
        
        peer.on('open', id => { 
            updateConnectionStatus('waiting', 'جاهز للاتصال');
            console.log('Peer ID:', id);
        });
        
        peer.on('connection', newConn => {
            if (isConnected) {
                newConn.close();
                return;
            }
            
            conn = newConn;
            myRole = 'O';
            setupConnectionHandlers();
        });
        
        // Handle incoming voice calls
        peer.on('call', incomingCall => {
            if (isVoiceActive) {
                incomingCall.close();
                return;
            }
            
            call = incomingCall;
            
            showModal("الخصم يريد بدء مكالمة صوتية. هل توافق؟", [
                {
                    text: "نعم",
                    class: "success",
                    action: async () => {
                        try {
                            localStream = await navigator.mediaDevices.getUserMedia({ 
                                audio: {
                                    echoCancellation: true,
                                    noiseSuppression: true,
                                    sampleRate: 44100
                                } 
                            });
                            
                            setupAudioAnalyzer();
                            call.answer(localStream);
                            setupCallHandlers();
                            
                            sendNetworkMessage({
                                type: 'voice_call_accepted',
                                timestamp: Date.now()
                            });
                            
                        } catch (error) {
                            console.error('Failed to answer call:', error);
                            voiceStatus.textContent = 'فشل في الإجابة على المكالمة';
                            voiceStatus.className = 'voice-status error';
                        }
                    }
                },
                {
                    text: "رفض",
                    class: "secondary",
                    action: () => {
                        call.close();
                        call = null;
                        sendNetworkMessage({
                            type: 'voice_call_rejected',
                            timestamp: Date.now()
                        });
                    }
                }
            ]);
        });
        
        peer.on('error', err => { 
            console.error('Peer error:', err);
            updateConnectionStatus('error', `خطأ: ${err.type}`);
            
            if (err.type === 'network') {
                showTemporaryStatus('خطأ في الشبكة. تحقق من الاتصال.', 3000, 'error');
            }
        });
    }

    function connectToPeer() {
        let remoteId = remotePeerIdInput.value.trim();
        
        try { 
            const url = new URL(remoteId); 
            remoteId = url.searchParams.get('join'); 
        } catch (e) {}
        
        if (!remoteId) { 
            showModal("الرجاء إدخال معرّف أو رابط دعوة صحيح.", [
                { text: "موافق", action: () => {} }
            ]); 
            return; 
        }
        
        updateConnectionStatus('connecting', 'جارٍ الاتصال...');
        connectBtn.disabled = true;
        
        conn = peer.connect(remoteId, { 
            reliable: true,
            serialization: 'json'
        });
        
        myRole = 'X';
        setupConnectionHandlers();
        
        connectionTimeout = setTimeout(() => {
            if (!isConnected) {
                updateConnectionStatus('error', 'فشل الاتصال - انتهت المهلة');
                connectBtn.disabled = false;
                cleanupConnection();
                initializePeer();
            }
        }, 15000);
    }

    function setupConnectionHandlers() {
        conn.on('open', () => {
            clearTimeout(connectionTimeout);
            updateConnectionStatus('connected', `متصل - أنت ${myRole}`);
            resetScores();
            gameCount = 0;
            startGame();
            
            sendNetworkMessage({
                type: 'handshake',
                role: myRole,
                timestamp: Date.now()
            });
        });
        
        conn.on('data', handleNetworkMessage);
        
        conn.on('close', () => {
            isConnected = false;
            updateConnectionStatus('error', 'انقطع الاتصال');
            showModal("انقطع الاتصال بالخصم.", [
                { text: "موافق", action: () => { handleGameModeChange(); } }
            ]);
        });
        
        conn.on('error', (err) => {
            console.error('Connection error:', err);
            updateConnectionStatus('error', 'خطأ في الاتصال');
            connectBtn.disabled = false;
        });
    }

    function sendNetworkMessage(data) { 
        if (conn?.open) {
            try {
                conn.send(data);
                return true;
            } catch (error) {
                console.error('Failed to send message:', error);
                return false;
            }
        }
        return false;
    }

    function handleNetworkMessage(msg) {
        console.log('Received message:', msg);
        
        switch (msg.type) {
            case 'handshake':
                console.log('Handshake received from opponent');
                break;
                
            case 'move':
                if (msg.gameCount !== undefined && msg.gameCount !== gameCount) {
                    console.log('Game count mismatch, ignoring move');
                    return;
                }
                
                if (msg.player && msg.index !== undefined && gameActive) {
                    makeMove(msg.index, msg.player);
                    if (gameActive) {
                        currentPlayer = msg.player === 'X' ? 'O' : 'X';
                        updateStatus();
                        updateBoardVisuals();
                    }
                    unlockBoard();
                }
                break;
                
            case 'restart_request':
                showModal("الخصم يريد بدء لعبة جديدة. هل توافق؟", [
                    { 
                        text: "نعم", 
                        class: "success", 
                        action: () => { 
                            sendNetworkMessage({ type: 'restart_confirm' }); 
                            startGame(); 
                        }
                    },
                    { 
                        text: "لا", 
                        class: "secondary", 
                        action: () => {
                            sendNetworkMessage({ type: 'restart_declined' });
                        } 
                    }
                ]);
                break;
                
            case 'restart_confirm':
                showTemporaryStatus("وافق الخصم على بدء لعبة جديدة.", 2000, 'success');
                startGame();
                break;
                
            case 'restart_declined':
                showTemporaryStatus("رفض الخصم بدء لعبة جديدة.", 2000, 'warning');
                break;
                
            case 'chat':
                if (msg.message) {
                    addChatMessage(msg.message, 'opponent');
                }
                break;
                
            case 'voice_call_request':
                voiceStatus.textContent = 'طلب مكالمة صوتية واردة...';
                voiceStatus.className = 'voice-status connecting';
                break;
                
            case 'voice_call_accepted':
                if (localStream && peer) {
                    call = peer.call(conn.peer, localStream);
                    setupCallHandlers();
                    playSound('voiceStart');
                }
                break;
                
            case 'voice_call_rejected':
                voiceStatus.textContent = 'رفض الخصم المكالمة الصوتية';
                voiceStatus.className = 'voice-status error';
                
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }
                
                setTimeout(() => {
                    voiceStatus.textContent = 'جاهز للمكالمة الصوتية';
                    voiceStatus.className = 'voice-status';
                }, 3000);
                break;
                
            case 'voice_call_ended':
                if (isVoiceActive) {
                    endVoiceCall();
                }
                break;
                
            case 'voice_mute_status':
                if (msg.isMuted !== undefined) {
                    const statusText = msg.isMuted ? 
                        'المكالمة نشطة (الخصم مكتوم)' : 
                        'المكالمة نشطة';
                    
                    if (voiceStatus.className.includes('active')) {
                        voiceStatus.textContent = statusText;
                    }
                }
                break;
        }
    }

    function addChatMessage(message, senderType) {
        const msgDiv = document.createElement('div');
        msgDiv.className = `chat-message ${senderType}`;
        
        const time = new Date().toLocaleTimeString('ar', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        msgDiv.innerHTML = `
            <div class="sender">${senderType === 'me' ? 'أنت' : 'الخصم'}</div>
            <div>${message}</div>
            <div class="time">${time}</div>
        `;
        
        chatMessages.appendChild(msgDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // --- Event Listeners ---
    gameModeSelect.addEventListener('change', () => { 
        playSound('click'); 
        handleGameModeChange(); 
    });
    
    connectBtn.addEventListener('click', () => { 
        playSound('click'); 
        connectToPeer(); 
    });
    
    disconnectBtn.addEventListener('click', () => {
        playSound('click');
        cleanupConnection();
        initializePeer();
    });
    
    inviteBtn.addEventListener('click', () => {
        playSound('click');
        if (peer && peer.id) {
            const inviteLink = `${window.location.origin}${window.location.pathname}?join=${peer.id}`;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(inviteLink).then(() => {
                    showModal("تم نسخ رابط الدعوة! شاركه مع صديقك للعب معاً.", [
                        { text: "رائع!", action: () => {} }
                    ]);
                }).catch(() => {
                    promptCopyLink(inviteLink);
                });
            } else {
                promptCopyLink(inviteLink);
            }
        } else {
            showModal("لا يمكن إنشاء رابط دعوة. تأكد من الاتصال بالإنترنت.", [
                { text: "موافق", action: () => {} }
            ]);
        }
    });
    
    function promptCopyLink(link) {
        showModal(`انسخ هذا الرابط وشاركه:\n\n${link}`, [
            { text: "موافق", action: () => {} }
        ]);
    }
    
    restartBtn.addEventListener('click', () => {
        playSound('click');
        if (gameMode === 'online' && isConnected) {
            sendNetworkMessage({ 
                type: 'restart_request',
                timestamp: Date.now()
            });
            showTemporaryStatus("تم إرسال طلب إعادة اللعب...", 2000, 'info');
        } else {
            startGame();
        }
    });
    
    newGameBtn.addEventListener('click', () => {
        playSound('click');
        showModal("هل تريد بدء جولة جديدة؟ سيتم إعادة تعيين النتائج.", [
            { 
                text: "نعم", 
                class: "success", 
                action: () => { 
                    resetScores(); 
                    startGame(); 
                }
            },
            { 
                text: "لا", 
                class: "secondary", 
                action: () => {} 
            }
        ]);
    });
    
    // Voice chat event listeners
    startVoiceBtn.addEventListener('click', () => {
        playSound('click');
        startVoiceCall();
    });
    
    muteBtn.addEventListener('click', () => {
        playSound('click');
        toggleMute();
    });
    
    endVoiceBtn.addEventListener('click', () => {
        playSound('click');
        endVoiceCall();
    });
    
    chatForm.addEventListener('submit', e => {
        e.preventDefault();
        const message = chatInput.value.trim();
        if (message && isConnected) {
            addChatMessage(message, 'me');
            sendNetworkMessage({ 
                type: 'chat', 
                message: message,
                timestamp: Date.now()
            });
            chatInput.value = '';
        } else if (!isConnected) {
            showTemporaryStatus('غير متصل بالخصم!', 1500, 'error');
        }
    });

    modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) {
            modalOverlay.style.display = 'none';
        }
    });

    // --- Initial Load ---
    const urlParams = new URLSearchParams(window.location.search);
    const joinId = urlParams.get('join');
    
    if (joinId) {
        gameModeSelect.value = 'online';
        remotePeerIdInput.value = joinId;
        showTemporaryStatus("تم العثور على دعوة! اضغط 'اتصال بالخصم' للانضمام.", 4000, 'info');
    }
    
    const savedScores = localStorage.getItem('xoScores');
    if (savedScores) {
        try {
            scores = JSON.parse(savedScores);
            updateScores();
        } catch (e) {
            console.log('Failed to load saved scores');
        }
    }
    
    handleGameModeChange();
    
    window.addEventListener('beforeunload', cleanupConnection);
});
</script>
</body>
</html>
